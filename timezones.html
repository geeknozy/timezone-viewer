<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Timezone Viewer</title>
    <style>
        /* General body styling for a clean look */
        body {
            font-family: 'Courier New', monospace;
            background-color: #999999;
            color: black;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem;
            box-sizing: border-box;
            line-height: 1.6;
        }

        /* Container for the main content */
        .container {
            width: 100%;
            max-width: 600px;
            padding: 2rem;
            border-radius: 0; /* Remove rounded corners */
            background-color: #cccccc;
            box-shadow: none; /* Remove box shadow */
            border: 2px outset #ffffff; /* Classic 3D border effect */
        }

        /* Styling for the header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            margin: 0;
            color: #333;
            text-shadow: 2px 2px 0 #ffffff; /* Classic text shadow */
        }
        
        /* Time format toggle styling */
        .format-toggle {
            text-align: center;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .format-toggle label {
            font-size: 1rem;
            cursor: pointer;
            margin-right: 0.5rem;
            color: #333;
        }

        .format-toggle input[type="checkbox"] {
            /* Basic checkbox styling to match retro theme */
            cursor: pointer;
            appearance: none;
            width: 16px;
            height: 16px;
            background-color: #ffffff;
            border: 2px inset #ffffff;
            position: relative;
            top: 1px;
        }

        .format-toggle input[type="checkbox"]:checked {
            background-color: #0066cc;
            border: 2px outset #ffffff;
        }

        .format-toggle .checkmark {
            position: absolute;
            top: 1px;
            left: 1px;
            width: 12px;
            height: 12px;
            pointer-events: none;
            display: none;
        }

        .format-toggle input[type="checkbox"]:checked ~ .checkmark {
            display: block;
        }

        /* Form styling */
        .timezone-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .input-container {
            position: relative;
            flex-grow: 1;
        }

        .timezone-form input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 2px inset #ffffff; /* Inset border for an embossed look */
            border-radius: 0;
            background-color: #ffffff;
            color: #333;
            box-shadow: none;
            box-sizing: border-box;
        }

        .timezone-form button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border: 2px outset #ffffff; /* Outset border for a pushed button look */
            border-radius: 0;
            background-color: #0066cc;
            color: white;
            cursor: pointer;
            transition: none; /* Remove smooth transitions */
        }

        .timezone-form button:hover {
            background-color: #0056b3;
            border: 2px inset #ffffff; /* Inset on hover to simulate a press */
            transform: none;
        }

        .timezone-form button:active {
            transform: none;
        }
        
        /* Message box for displaying user feedback or errors */
        .message-box {
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0;
            background-color: #ffffcc;
            color: #856404;
            border: 2px inset #ffffff;
            display: none; /* Hidden by default */
        }
        .message-box.show {
            display: block;
        }

        /* Container for the timezone list */
        .timezone-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timezone-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #dddddd;
            border: 2px outset #ffffff;
            border-radius: 0;
            box-shadow: none;
            transition: none;
        }
        .timezone-item:hover {
            transform: none;
        }

        .timezone-item p {
            margin: 0;
        }

        .timezone-item .time {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .timezone-item button {
            background-color: #cc0000;
            color: white;
            border: 2px outset #ffffff;
            border-radius: 0;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: none;
        }
        .timezone-item button:hover {
            background-color: #b30000;
            border: 2px inset #ffffff;
        }

        /* Custom suggestion styles */
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            width: 100%;
            background-color: #ffffff;
            border: 2px outset #ffffff;
            border-radius: 0;
            box-shadow: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }

        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px dotted #999999;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        /* New active and hover state */
        .suggestion-item.active,
        .suggestion-item:hover {
            background-color: #dddddd;
        }

        /* Styles for the modal pop-up */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-box {
            background-color: #cccccc;
            padding: 1.5rem;
            border: 2px outset #ffffff;
            box-shadow: none;
            text-align: center;
            max-width: 400px;
        }

        .modal-box p {
            color: #333;
            margin-bottom: 1.5rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .modal-buttons button {
            padding: 0.5rem 1rem;
            border: 2px outset #ffffff;
            border-radius: 0;
            cursor: pointer;
            color: white;
            transition: none;
        }

        .modal-buttons button:hover {
            border: 2px inset #ffffff;
        }
        
        .accept-button {
            background-color: #0066cc;
        }

        .decline-button {
            background-color: #cc0000;
        }

    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <h1>Simple Timezone Viewer</h1>
        </header>
        
        <!-- Time format toggle -->
        <div class="format-toggle">
            <input type="checkbox" id="hourFormatToggle">
            <label for="hourFormatToggle">24-Hour Format</label>
            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                <path d="M14 27l12 12 12-12" stroke="#fff" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </div>

        <!-- Message box for user feedback -->
        <div class="message-box" id="messageBox"></div>

        <!-- Form for adding new timezones -->
        <div class="timezone-form">
            <div class="input-container">
                <input type="text" id="timezoneInput" placeholder="e.g., Europe/Paris">
                <!-- Custom suggestion list container -->
                <div id="suggestionList" class="suggestion-list" style="display: none;"></div>
            </div>
            <button id="addButton">Add Timezone</button>
        </div>

        <!-- List to display added timezones -->
        <div class="timezone-list" id="timezoneListContainer">
            <!-- Timezones will be added here dynamically -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const timezoneInput = document.getElementById('timezoneInput');
            const addButton = document.getElementById('addButton');
            const timezoneListContainer = document.getElementById('timezoneListContainer');
            const messageBox = document.getElementById('messageBox');
            const suggestionList = document.getElementById('suggestionList');
            const hourFormatToggle = document.getElementById('hourFormatToggle');
            let savedTimezones = [];
            let intervalId = null;
            let activeSuggestionIndex = -1;
            let is24HourFormat = false;

            // A mapping of common timezone abbreviations to their official IANA timezones.
            const timezoneMap = {
                'CET': 'Europe/Paris',
                'CEST': 'Europe/Paris',
                'UTC': 'UTC',
                'KOLKATA': 'Asia/Calcutta',
                'IST': 'Asia/Calcutta',
                'INDIA': 'Asia/Calcutta',
                'GMT': 'GMT',
                'NEW DELHI': 'Asia/Calcutta',
                'MUMBAI': 'Asia/Calcutta'
            };

            // Comprehensive list of IANA timezones and custom abbreviations.
            const allTimezones = [
                ...Object.keys(timezoneMap), 
                'Africa/Abidjan', 'Africa/Accra', 'Africa/Addis_Ababa', 'Africa/Algiers', 'Africa/Asmara',
                'Africa/Bamako', 'Africa/Bangui', 'Africa/Banjul', 'Africa/Bissau', 'Africa/Blantyre',
                'Africa/Brazzaville', 'Africa/Bujumbura', 'Africa/Cairo', 'Africa/Casablanca', 'Africa/Ceuta',
                'Africa/Conakry', 'Africa/Dakar', 'Africa/Dar_es_Salaam', 'Africa/Djibouti', 'Africa/Douala',
                'Africa/El_Aaiun', 'Africa/Freetown', 'Africa/Gaborone', 'Africa/Harare', 'Africa/Johannesburg',
                'Africa/Juba', 'Africa/Kampala', 'Africa/Khartoum', 'Africa/Kigali', 'Africa/Kinshasa',
                'Africa/Lagos', 'Africa/Libreville', 'Africa/Lome', 'Africa/Luanda', 'Africa/Lubumbashi',
                'Africa/Lusaka', 'Africa/Malabo', 'Africa/Maputo', 'Africa/Maseru', 'Africa/Mbabane',
                'Africa/Mogadishu', 'Africa/Monrovia', 'Africa/Nairobi', 'Africa/Ndjamena', 'Africa/Niamey',
                'Africa/Nouakchott', 'Africa/Ouagadougou', 'Africa/Porto-Novo', 'Africa/Sao_Tome', 'Africa/Tripoli',
                'Africa/Tunis', 'Africa/Windhoek', 'America/Adak', 'America/Anchorage', 'America/Anguilla',
                'America/Antigua', 'America/Araguaina', 'America/Argentina/Buenos_Aires', 'America/Argentina/Catamarca',
                'America/Argentina/Cordoba', 'America/Argentina/Jujuy', 'America/Argentina/La_Rioja',
                'America/Argentina/Mendoza', 'America/Argentina/Rio_Gallegos', 'America/Argentina/Salta',
                'America/Argentina/San_Juan', 'America/Argentina/San_Luis', 'America/Argentina/Tucuman',
                'America/Argentina/Ushuaia', 'America/Aruba', 'America/Asuncion', 'America/Atikokan',
                'America/Bahia', 'America/Bahia_Banderas', 'America/Barbados', 'America/Belem', 'America/Belize',
                'America/Blanc-Sablon', 'America/Bogota', 'America/Boise', 'America/Cambridge_Bay', 'America/Campo_Grande',
                'America/Cancun', 'America/Caracas', 'America/Cayenne', 'America/Cayman', 'America/Chicago',
                'America/Chihuahua', 'America/Costa_Rica', 'America/Creston', 'America/Cuiaba', 'America/Curacao',
                'America/Danmarkshavn', 'America/Dawson', 'America/Dawson_Creek', 'America/Denver', 'America/Detroit',
                'America/Dominica', 'America/Edmonton', 'America/Eirunepe', 'America/El_Salvador', 'America/Fort_Nelson',
                'America/Fortaleza', 'America/Glace_Bay', 'America/Goose_Bay', 'America/Grand_Turk', 'America/Grenada',
                'America/Guadeloupe', 'America/Guatemala', 'America/Guayaquil', 'America/Guyana', 'America/Halifax',
                'America/Havana', 'America/Hermosillo', 'America/Indiana/Indianapolis', 'America/Indiana/Knox',
                'America/Indiana/Marengo', 'America/Indiana/Petersburg', 'America/Indiana/Tell_City',
                'America/Indiana/Vevay', 'America/Indiana/Vincennes', 'America/Indiana/Winamac', 'America/Inuvik',
                'America/Iqaluit', 'America/Jamaica', 'America/Juneau', 'America/Kentucky/Louisville',
                'America/Kentucky/Monticello', 'America/Kralendijk', 'America/La_Paz', 'America/Lima',
                'America/Los_Angeles', 'America/Lower_Princes', 'America/Maceio', 'America/Managua', 'America/Manaus',
                'America/Marigot', 'America/Martinique', 'America/Matamoros', 'America/Mazatlan', 'America/Menominee',
                'America/Merida', 'America/Metlakatla', 'America/Mexico_City', 'America/Miquelon', 'America/Moncton',
                'America/Monterrey', 'America/Montevideo', 'America/Montreal', 'America/Montserrat', 'America/Nassau',
                'America/New_York', 'America/Nipigon', 'America/Nome', 'America/Noronha', 'America/North_Dakota/Beulah',
                'America/North_Dakota/Center', 'America/North_Dakota/New_Salem', 'America/Nuuk', 'America/Ojinaga',
                'America/Panama', 'America/Paramaribo', 'America/Phoenix', 'America/Port-au-Prince', 'America/Port_of_Spain',
                'America/Porto_Velho', 'America/Puerto_Rico', 'America/Punta_Arenas', 'America/Rainy_River',
                'America/Rankin_Inlet', 'America/Recife', 'America/Regina', 'America/Resolute', 'America/Rio_Branco',
                'America/Santarem', 'America/Santiago', 'America/Santo_Domingo', 'America/Sao_Paulo', 'America/Scoresbysund',
                'America/Sitka', 'America/St_Barthelemy', 'America/St_Johns', 'America/St_Kitts', 'America/St_Lucia',
                'America/St_Thomas', 'America/St_Vincent', 'America/Swift_Current', 'America/Tegucigalpa',
                'America/Thule', 'America/Thunder_Bay', 'America/Tijuana', 'America/Toronto', 'America/Tortola',
                'America/Vancouver', 'America/Whitehorse', 'America/Winnipeg', 'America/Yakutat', 'America/Yellowknife',
                'Antarctica/Casey', 'Antarctica/Davis', 'Antarctica/DumontDUrville', 'Antarctica/Macquarie',
                'Antarctica/Mawson', 'Antarctica/McMurdo', 'Antarctica/Palmer', 'Antarctica/Rothera',
                'Antarctica/Syowa', 'Antarctica/Troll', 'Antarctica/Vostok', 'Asia/Almaty', 'Asia/Amman',
                'Asia/Anadyr', 'Asia/Aqtau', 'Asia/Aqtobe', 'Asia/Ashgabat', 'Asia/Atyrau', 'Asia/Baghdad',
                'Asia/Baku', 'Asia/Bangkok', 'Asia/Barnaul', 'Asia/Beirut', 'Asia/Bishkek', 'Asia/Brunei',
                'Asia/Calcutta', 'Asia/Chita', 'Asia/Choibalsan', 'Asia/Colombo', 'Asia/Damascus', 'Asia/Dhaka',
                'Asia/Dili', 'Asia/Dubai', 'Asia/Dushanbe', 'Asia/Famagusta', 'Asia/Gaza', 'Asia/Hebron',
                'Asia/Ho_Chi_Minh', 'Asia/Hong_Kong', 'Asia/Hovd', 'Asia/Irkutsk', 'Asia/Jakarta', 'Asia/Jayapura',
                'Asia/Jerusalem', 'Asia/Kabul', 'Asia/Kamchatka', 'Asia/Karachi', 'Asia/Kathmandu', 'Asia/Khandyga',
                'Asia/Krasnoyarsk', 'Asia/Kuala_Lumpur', 'Asia/Kuching', 'Asia/Kuwait', 'Asia/Macau', 'Asia/Magadan',
                'Asia/Makassar', 'Asia/Manila', 'Asia/Muscat', 'Asia/Nicosia', 'Asia/Novokuznetsk', 'Asia/Novosibirsk',
                'Asia/Omsk', 'Asia/Oral', 'Asia/Pontianak', 'Asia/Pyongyang', 'Asia/Qatar', 'Asia/Qostanay',
                'Asia/Qyzylorda', 'Asia/Riyadh', 'Asia/Sakhalin', 'Asia/Samarkand', 'Asia/Seoul', 'Asia/Shanghai',
                'Asia/Singapore', 'Asia/Srednekolymsk', 'Asia/Taipei', 'Asia/Tashkent', 'Asia/Tbilisi', 'Asia/Tehran',
                'Asia/Thimphu', 'Asia/Tokyo', 'Asia/Tomsk', 'Asia/Ulaanbaatar', 'Asia/Urumqi', 'Asia/Ust-Nera',
                'Asia/Vladivostok', 'Asia/Yakutsk', 'Asia/Yangon', 'Asia/Yekaterinburg', 'Asia/Yerevan',
                'Atlantic/Azores', 'Atlantic/Bermuda', 'Atlantic/Canary', 'Atlantic/Cape_Verde', 'Atlantic/Faroe',
                'Atlantic/Madeira', 'Atlantic/Reykjavik', 'Atlantic/South_Georgia', 'Atlantic/St_Helena', 'Atlantic/Stanley',
                'Australia/Adelaide', 'Australia/Brisbane', 'Australia/Broken_Hill', 'Australia/Currie',
                'Australia/Darwin', 'Australia/Eucla', 'Australia/Hobart', 'Australia/Lindeman',
                'Australia/Lord_Howe', 'Australia/Melbourne', 'Australia/Perth', 'Australia/Sydney',
                'Europe/Amsterdam', 'Europe/Andorra', 'Europe/Astrakhan', 'Europe/Athens', 'Europe/Belgrade',
                'Europe/Berlin', 'Europe/Bratislava', 'Europe/Brussels', 'Europe/Bucharest', 'Europe/Budapest',
                'Europe/Busingen', 'Europe/Chisinau', 'Europe/Copenhagen', 'Europe/Dublin', 'Europe/Gibraltar',
                'Europe/Guernsey', 'Europe/Helsinki', 'Europe/Isle_of_Man', 'Europe/Istanbul', 'Europe/Jersey',
                'Europe/Kaliningrad', 'Europe/Kiev', 'Europe/Kirov', 'Europe/Lisbon', 'Europe/Ljubljana',
                'Europe/London', 'Europe/Luxembourg', 'Europe/Madrid', 'Europe/Malta', 'Europe/Minsk', 'Europe/Monaco',
                'Europe/Moscow', 'Europe/Oslo', 'Europe/Paris', 'Europe/Podgorica', 'Europe/Prague', 'Europe/Riga',
                'Europe/Rome', 'Europe/Samara', 'Europe/San_Marino', 'Europe/Sarajevo', 'Europe/Saratov',
                'Europe/Simferopol', 'Europe/Skopje', 'Europe/Sofia', 'Europe/Stockholm', 'Europe/Tallinn',
                'Europe/Tirane', 'Europe/Ulyanovsk', 'Europe/Uzhgorod', 'Europe/Vaduz', 'Europe/Vatican',
                'Europe/Vienna', 'Europe/Vilnius', 'Europe/Volgograd', 'Europe/Warsaw', 'Europe/Zagreb',
                'Europe/Zaporozhye', 'Europe/Zurich', 'Indian/Antananarivo', 'Indian/Chagos', 'Indian/Christmas',
                'Indian/Cocos', 'Indian/Comoro', 'Indian/Kerguelen', 'Indian/Mahe', 'Indian/Maldives',
                'Indian/Mauritius', 'Indian/Mayotte', 'Indian/Reunion', 'Pacific/Apia', 'Pacific/Auckland',
                'Pacific/Bougainville', 'Pacific/Chatham', 'Pacific/Chuuk', 'Pacific/Easter', 'Pacific/Efate',
                'Pacific/Enderbury', 'Pacific/Fakaofo', 'Pacific/Fiji', 'Pacific/Funafuti', 'Pacific/Galapagos',
                'Pacific/Gambier', 'Pacific/Guadalcanal', 'Pacific/Guam', 'Pacific/Honolulu', 'Pacific/Kanton',
                'Pacific/Kiritimati', 'Pacific/Kosrae', 'Pacific/Kwajalein', 'Pacific/Majuro', 'Pacific/Marquesas',
                'Pacific/Midway', 'Pacific/Nauru', 'Pacific/Niue', 'Pacific/Norfolk', 'Pacific/Noumea',
                'Pacific/Pago_Pago', 'Pacific/Palau', 'Pacific/Pitcairn', 'Pacific/Pohnpei', 'Pacific/Port_Moresby',
                'Pacific/Rarotonga', 'Pacific/Saipan', 'Pacific/Tahiti', 'Pacific/Tarawa', 'Pacific/Tongatapu',
                'Pacific/Wake', 'Pacific/Wallis'
            ].sort();

            // Function to display messages to the user
            const showMessage = (message, type = 'info') => {
                messageBox.textContent = message;
                messageBox.className = `message-box show`;
                if (type === 'error') {
                    messageBox.style.backgroundColor = '#f8d7da';
                    messageBox.style.color = '#721c24';
                    messageBox.style.borderColor = '#f5c6cb';
                } else {
                    messageBox.style.backgroundColor = '#d1ecf1';
                    messageBox.style.color = '#0c5460';
                    messageBox.style.borderColor = '#bee5eb';
                }
                setTimeout(() => {
                    messageBox.className = 'message-box';
                }, 3000); // Hide message after 3 seconds
            };
            
            // Function to check if local storage is available
            const isLocalStorageAvailable = () => {
                try {
                    const testKey = '__test__';
                    localStorage.setItem(testKey, testKey);
                    localStorage.removeItem(testKey);
                    return true;
                } catch (e) {
                    return false;
                }
            };

            // Main initialization function
            const init = () => {
                if (isLocalStorageAvailable()) {
                    const localStoragePermission = localStorage.getItem('localStoragePermission');

                    if (localStoragePermission === null) {
                        showPermissionModal();
                    } else {
                        loadTimezones();
                    }
                } else {
                    loadTimezones(); // Load without saving, as local storage is not supported
                }
            };

            // Function to show the permission modal
            const showPermissionModal = () => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-box">
                        <p>This site would like to save your timezones locally in your browser for a better experience. Do you accept?</p>
                        <div class="modal-buttons">
                            <button id="acceptBtn" class="accept-button">Accept</button>
                            <button id="declineBtn" class="decline-button">Decline</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('acceptBtn').addEventListener('click', () => {
                    localStorage.setItem('localStoragePermission', 'accepted');
                    modal.remove();
                    loadTimezones();
                });

                document.getElementById('declineBtn').addEventListener('click', () => {
                    localStorage.setItem('localStoragePermission', 'denied');
                    modal.remove();
                    loadTimezones();
                });
            };

            // Function to load timezones and preferences from local storage
            const loadTimezones = () => {
                if (localStorage.getItem('localStoragePermission') === 'accepted' && isLocalStorageAvailable()) {
                    const storedTimezones = localStorage.getItem('timezones');
                    if (storedTimezones) {
                        savedTimezones = JSON.parse(storedTimezones);
                    }
                    const storedFormat = localStorage.getItem('is24HourFormat');
                    is24HourFormat = storedFormat ? JSON.parse(storedFormat) : false;
                    hourFormatToggle.checked = is24HourFormat;
                }
                renderTimezones();
            };

            // Function to save timezones and preferences to local storage
            const saveTimezones = () => {
                if (localStorage.getItem('localStoragePermission') === 'accepted' && isLocalStorageAvailable()) {
                    localStorage.setItem('timezones', JSON.stringify(savedTimezones));
                    localStorage.setItem('is24HourFormat', JSON.stringify(is24HourFormat));
                }
            };

            // Function to render the list of timezones
            const renderTimezones = () => {
                timezoneListContainer.innerHTML = '';
                if (savedTimezones.length === 0) {
                    timezoneListContainer.innerHTML = '<p style="text-align: center; color: #555;">No timezones added yet.</p>';
                } else {
                    savedTimezones.forEach(tzObj => {
                        const timezoneItem = document.createElement('div');
                        timezoneItem.className = 'timezone-item';
                        timezoneItem.innerHTML = `
                            <p><strong>${tzObj.label}</strong><br><span class="time" data-timezone="${tzObj.timezone}"></span></p>
                            <button class="remove-btn">Remove</button>
                        `;
                        timezoneItem.querySelector('.remove-btn').addEventListener('click', () => removeTimezone(tzObj.label));
                        timezoneListContainer.appendChild(timezoneItem);
                    });
                }
                updateTimes(); // Initial time update
                if (intervalId) clearInterval(intervalId); // Clear existing interval
                intervalId = setInterval(updateTimes, 1000); // Update times every second
            };

            // Function to update the time for each timezone
            const updateTimes = () => {
                const timeElements = document.querySelectorAll('.timezone-item .time');
                const now = new Date();
                timeElements.forEach(el => {
                    const tz = el.getAttribute('data-timezone');
                    try {
                        const options = {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            timeZoneName: 'short',
                            timeZone: tz,
                            hour12: !is24HourFormat
                        };
                        const timeString = new Intl.DateTimeFormat('en-US', options).format(now);
                        el.textContent = timeString;
                    } catch (e) {
                        // Handle invalid timezone
                        el.textContent = 'Invalid Timezone';
                        el.style.color = 'red';
                    }
                });
            };

            // Function to add a timezone
            const addTimezone = (label) => {
                let timezone;
                const normalizedLabel = label.toUpperCase();

                // Check if the label is in our map and use the corresponding IANA timezone for calculation
                if (timezoneMap[normalizedLabel]) {
                    timezone = timezoneMap[normalizedLabel];
                } else {
                    timezone = label; // Use the label as the timezone if no map entry exists
                }

                // Perform a case-insensitive duplicate check
                const isDuplicate = savedTimezones.some(tzObj => tzObj.label.toLowerCase() === label.toLowerCase());

                if (label && !isDuplicate) {
                    try {
                        // Validate the timezone (either the mapped one or the original)
                        new Intl.DateTimeFormat('en-US', { timeZone: timezone });

                        // Add the new timezone object to the array
                        savedTimezones.push({ label: label, timezone: timezone });
                        saveTimezones();
                        renderTimezones();
                        timezoneInput.value = '';
                    } catch (e) {
                        showMessage('Invalid timezone. Please enter a valid one.', 'error');
                    }
                } else if (isDuplicate) {
                    showMessage('This timezone is already in the list.', 'info');
                }
            };

            // Function to remove a timezone
            const removeTimezone = (labelToRemove) => {
                savedTimezones = savedTimezones.filter(tzObj => tzObj.label !== labelToRemove);
                saveTimezones();
                renderTimezones();
            };

            // Function to render the custom suggestion list
            const renderSuggestions = (query) => {
                suggestionList.innerHTML = '';
                if (query.length > 0) {
                    const filteredTimezones = allTimezones.filter(tz =>
                        tz.toLowerCase().includes(query.toLowerCase())
                    ).slice(0, 10); // Limit to 10 suggestions
                    
                    if (filteredTimezones.length > 0) {
                        filteredTimezones.forEach((tz, index) => {
                            const suggestionItem = document.createElement('div');
                            suggestionItem.className = 'suggestion-item';
                            if (index === activeSuggestionIndex) {
                                suggestionItem.classList.add('active');
                            }
                            suggestionItem.textContent = tz;
                            suggestionItem.addEventListener('click', () => {
                                timezoneInput.value = tz;
                                addTimezone(tz);
                                suggestionList.style.display = 'none';
                                timezoneInput.focus(); 
                            });
                            suggestionList.appendChild(suggestionItem);
                        });
                        suggestionList.style.display = 'block';
                    } else {
                        suggestionList.style.display = 'none';
                    }
                } else {
                    suggestionList.style.display = 'none';
                }
            };

            // Event listeners for custom suggestions
            timezoneInput.addEventListener('input', (e) => {
                activeSuggestionIndex = -1; // Reset active index on new input
                renderSuggestions(e.target.value);
            });

            // Handle keyboard navigation for suggestions
            timezoneInput.addEventListener('keydown', (e) => {
                const suggestions = suggestionList.children;
                if (suggestions.length > 0) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault(); // Prevent cursor movement in the input
                        activeSuggestionIndex = (activeSuggestionIndex + 1) % suggestions.length;
                        updateActiveSuggestion();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        activeSuggestionIndex = (activeSuggestionIndex - 1 + suggestions.length) % suggestions.length;
                        updateActiveSuggestion();
                    } else if (e.key === 'Enter') {
                        if (activeSuggestionIndex > -1) {
                            e.preventDefault(); // Prevent form submission
                            suggestions[activeSuggestionIndex].click();
                        } else if (suggestions.length === 1) {
                            // Automatically add the single suggestion if Enter is pressed
                            addTimezone(suggestions[0].textContent);
                            suggestionList.style.display = 'none';
                            timezoneInput.value = '';
                        }
                    }
                }
            });

            const updateActiveSuggestion = () => {
                const suggestions = suggestionList.children;
                for (let i = 0; i < suggestions.length; i++) {
                    suggestions[i].classList.remove('active');
                }
                if (activeSuggestionIndex > -1) {
                    suggestions[activeSuggestionIndex].classList.add('active');
                    timezoneInput.value = suggestions[activeSuggestionIndex].textContent;
                }
            };

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!timezoneInput.contains(e.target) && !suggestionList.contains(e.target)) {
                    suggestionList.style.display = 'none';
                    activeSuggestionIndex = -1;
                }
            });

            // Event listener for the hour format toggle
            hourFormatToggle.addEventListener('change', (e) => {
                is24HourFormat = e.target.checked;
                saveTimezones(); // Save the new preference
                updateTimes(); // Instantly update the displayed times
            });

            // Event listeners
            addButton.addEventListener('click', () => {
                const query = timezoneInput.value;
                if (query.trim() !== '') {
                    addTimezone(query);
                    suggestionList.style.display = 'none';
                    activeSuggestionIndex = -1;
                }
            });

            // Run the main initialization function
            init();
        });
    </script>

</body>
</html>
